---
title: "Ch.3 Spatial descriptive Statistics"
author: '17086269'
date: "4/13/2022"
output: html_document
---
```{r}
library(here)
here()
```


```{r setup, include=FALSE}
library(sf)
library(here)
st_layers(here("CHAP3", "prac3_data", "gadm36_AUS.gpkg"))

# library(sf)
Ausoutline <- st_read(here("CHAP3", "prac3_data", "gadm36_AUS.gpkg"),
                      layer='gadm36_AUS_0')
print(Ausoutline)
```

#3.5.1.2 proj4
```{r}
# library(sf)
st_crs(Ausoutline)$proj4string
```

#EPSG - set CRS (WGS84 or EPSG 4326)
```{r}
Ausoutline <- Ausoutline %>%
  st_set_crs(., 4326)

# Hide#or more concisely
Ausoutline <- st_read(here("CHAP3","prac3_data", "gadm36_AUS.gpkg"), 
                      layer='gadm36_AUS_0') %>% 
  st_set_crs(4326)
``` 

# Reprojecting spatial data
```{r}
AusoutlinePROJECTED <- Ausoutline %>%
  st_transform(.,3112)

print(AusoutlinePROJECTED)


#From sf to sp
AusoutlineSP <- Ausoutline %>%
  as(., "Spatial")

#From sp to sf
AusoutlineSF <- AusoutlineSP %>%
  st_as_sf()
```


```{r}
library(raster)
jan <- raster(here("CHAP3","prac3_data","wc2.1_5m_tavg","wc2.1_5m_tavg_04.tif"))
# have a look at the raster layer April
jan
plot(jan)
```


```{r}
# set the proj 4 to a new object
newproj<-"+proj=moll +lon_0=0 +x_0=0 +y_0=0 +ellps=WGS84 +datum=WGS84 +units=m +no_defs"
# get the jan raster and give it the new proj4
pr1 <- jan %>%
  projectRaster(., crs=newproj)
plot(pr1)

pr1 <- pr1 %>%
  projectRaster(., crs="+init=epsg:4326")
plot(pr1)
```


## Data Loading
```{r}
# look in our folder, find the files that end with .tif and 
library(fs)
dir_info("prac3_data/") 
```

```{r}
library(tidyverse)
listfiles<-dir_info("prac3_data/wc2.1_5m_tavg") %>%
  filter(str_detect(path, ".tif")) %>%
  dplyr::select(path)%>%
  pull()

#have a look at the file names 
listfiles
```
## Load into a raster stack()
```{r}
worldclimtemp <- listfiles %>%
  stack()
  
#have a look at the raster stack
worldclimtemp
```

## Access single layer within the stack
```{r}
# access the january layer
worldclimtemp[[1]]
```


## Rename layers within the stack
```{r}
month <- c("Jan", "Feb" , "Mar", "Apr", "May", "Jun", 
           "Jul", "Aug", "Sep", "Oct", "Nov", "Dec")

names(worldclimtemp) <- month

worldclimtemp$Jan
```

## Raster location
```{r}
site <- c("Brisbane", "Melbourne", "Perth", "Sydney", "Broome", "Darwin", "Orange", 
          "Bunbury", "Cairns", "Adelaide", "Gold Coast", "Canberra", "Newcastle", 
          "Wollongong", "Logan City" )
lon <- c(153.03, 144.96, 115.86, 151.21, 122.23, 130.84, 149.10, 115.64, 145.77, 
         138.6, 153.43, 149.13, 151.78, 150.89, 153.12)
lat <- c(-27.47, -37.91, -31.95, -33.87, 17.96, -12.46, -33.28, -33.33, -16.92, 
         -34.93, -28, -35.28, -32.93, -34.42, -27.64)
#Put all of this nformation into one list 
samples <- data.frame(site, lon, lat, row.names="site")
# Extract the data from the Rasterstack for all points 
AUcitytemp<- raster::extract(worldclimtemp, samples)
```

```{r}
Aucitytemp2 <- AUcitytemp %>% 
  as_tibble()%>% 
  add_column(Site = site, .before = "Jan")
```


# Descriptive Statistics

```{r}
#  subset our data either using the row name
Perthtemp <- Aucitytemp2 %>% 
  filter(site=="Perth")
```
```{r}
# subset our data using row location
Perthtemp <- Aucitytemp2[3,]
```

## Histogram
```{r}
hist(as.numeric(Perthtemp))
```
## Improve the histogram
```{r}
#define where you want the breaks in the historgram
userbreak<-c(8,10,12,14,16,18,20,22,24,26)
hist(as.numeric(Perthtemp), 
     breaks=userbreak, 
     col="white", 
     main="Histogram of Perth Temperature", 
     xlab="Temperature", 
     ylab="Frequency")
```
## histogram info generated by R
```{r}
histinfo <- Perthtemp %>%
  as.numeric()%>%
  hist(.)

histinfo

# breaks — the cut off points for the bins (or bars), we just specified these
# counts — the number of cells in each bin
# midpoints — the middle value for each bin
# density — the density of data per bin
```
## Using more data
## Brief glance with a smaller size of plot
```{r}
plot(Ausoutline$geom)

#load the rmapshaper package
library(rmapshaper)
#simplify the shapefile
#keep specifies the % of points
#to keep
AusoutSIMPLE<-Ausoutline %>%
  ms_simplify(.,keep=0.05)

plot(AusoutSIMPLE$geom)
```
## set our map extent (where we want to clip the data to) to the outline of Australia then crop our WorldClim (explainatory/feature dataset) dataset to it.
```{r}
# check Australia outline coordinate reference system (CRS) <- WGS 84
print(Ausoutline)

# check World Climate coordinate reference system (CRS)[Raster] <- WGS 84
#this works nicely for rasters
crs(worldclimtemp)

```

```{r}
Austemp <- Ausoutline %>%
  # now crop our temp data to the extent
  crop(worldclimtemp,.)

# plot the output
plot(Austemp)
```
```{r}
#If want to just get raster data within the outline of the shape:
exactAus <- Austemp %>%
  mask(.,Ausoutline, na.rm=TRUE)
```

## Another look into histogram using extracted data within the "extent"
```{r}
#subset using the known location of the raster (i.e. 3 <- March in exactAus)
hist(exactAus[[3]], col="red", main ="March temperature")



#OR
#subset with the word Mar
hist(raster::subset(exactAus, "Mar"), col="red", main ="March temperature")
```

# Histogram with ggplot()

## Make raster into data.frame so that it is compatible with ggplot()
```{r}
exactAusdf <- exactAus %>%
  as.data.frame()
```

```{r}
library(ggplot2)
# set up the basic histogram
gghist <- ggplot(exactAusdf, 
                 aes(x=Mar)) +  #aes <- pick the subset (i.e. March)
  geom_histogram(color="black", 
                 fill="white")+
  labs(title="Ggplot2 histogram of Australian March temperatures", 
       x="Temperature", 
       y="Frequency")
# add a vertical line to the histogram showing mean temperature
gghist + geom_vline(aes(xintercept=mean(Mar, 
                                        na.rm=TRUE)),
            color="blue", 
            linetype="dashed", 
            size=1)+
  theme(plot.title = element_text(hjust = 0.5))
```


## Multiple months of Temperature data on same histogram

As we did in practical 2, we need to put our variable (months) into a one column using pivot_longer(). Here, we are saying select columns 1-12 (all the months) and place them in a new column called Month and their values in another called Temp
```{r}
squishdata <- exactAusdf %>% 
  pivot_longer(
    cols = 1:12,
    names_to = "Month",
    values_to = "Temp"
  )
```

```{r}
twomonths <- squishdata %>%
  # | = OR
  filter(., Month=="Jan" | Month=="Jun")
```

## Groupby and summarize
```{r}
meantwomonths <- twomonths %>%
  group_by(Month) %>%
  summarise(mean=mean(Temp, na.rm=TRUE))

meantwomonths
```

## Start plotting
Select the colour and fill based on the variable (which is our month). The intercept is the mean we just calculated, with the lines also based on the coloumn variable.

```{r}
ggplot(squishdata, aes(x=Temp, color=Month, fill=Month)) +
  geom_histogram(position="identity", alpha=0.5)+
  geom_vline(data=meantwomonths, 
             aes(xintercept=mean, 
                 color=Month),
             linetype="dashed")+
  labs(title="Ggplot2 histogram of Australian Jan and Jun
       temperatures",
       x="Temperature",
       y="Frequency")+
  theme_classic()+
  theme(plot.title = element_text(hjust = 0.5))
```

## Dropping NAs

Have you been getting an annoying error message about bin size and non-finate values? Me too!…Bin size defaults to 30 in ggplot2 and the non-finate values is referring to lots of NAs (no data) that we have in our dataset. In the code below i’ve:
dropped all the NAs with drop_na()

made sure that the Month column has the levels specified, which will map in descending order (e.g. Jan, Feb, March..)

selected a bin width of 5 and produced a faceted plot…
```{r}
data_complete_cases <- squishdata %>%
  drop_na()%>% 
  mutate(Month = factor(Month, levels = c("Jan","Feb","Mar",
                                          "Apr","May","Jun",
                                          "Jul","Aug","Sep",
                                          "Oct","Nov","Dec")))

# Plot faceted histogram
ggplot(data_complete_cases, aes(x=Temp, na.rm=TRUE))+
  geom_histogram(color="black", binwidth = 5)+
  labs(title="Ggplot2 faceted histogram of Australian temperatures", 
       x="Temperature",
       y="Frequency")+
  facet_grid(Month ~ .)+
  theme(plot.title = element_text(hjust = 0.5))
```

## Use Plotly to plot
```{r}
library(plotly)
# split the data for plotly based on month

jan <- squishdata %>%
  drop_na() %>%
  filter(., Month=="Jan")

jun <- squishdata %>%
  drop_na() %>%
  filter(., Month=="Jun")

# give axis titles
x <- list (title = "Temperature")
y <- list (title = "Frequency")

# set the bin width
xbinsno<-list(start=0, end=40, size = 2.5)

# plot the histogram calling all the variables we just set
ihist<-plot_ly(alpha = 0.6) %>%
        add_histogram(x = jan$Temp,
        xbins=xbinsno, name="January") %>%
        add_histogram(x = jun$Temp,
        xbins=xbinsno, name="June") %>% 
        layout(barmode = "overlay", xaxis=x, yaxis=y)

ihist
```




# Summary Statistics CHEATSHEET
```{r}

# mean per month
meanofall <- squishdata %>%
  group_by(Month) %>%
  summarise(mean = mean(Temp, na.rm=TRUE))

# print the top 1
head(meanofall, n=1)


# standard deviation per month
sdofall <- squishdata %>%
  group_by(Month) %>%
  summarize(sd = sd(Temp, na.rm=TRUE))

# maximum per month
maxofall <- squishdata %>%
  group_by(Month) %>%
  summarize(max = max(Temp, na.rm=TRUE))

# minimum per month
minofall <- squishdata %>%
  group_by(Month) %>%
  summarize(min = min(Temp, na.rm=TRUE))

# Interquartlie range per month
IQRofall <- squishdata %>%
  group_by(Month) %>%
  summarize(IQR = IQR(Temp, na.rm=TRUE))

# perhaps you want to store multiple outputs in one list..
lotsofstats <- squishdata %>%
  group_by(Month) %>%
  summarize(IQR = IQR(Temp, na.rm=TRUE), 
            max=max(Temp, na.rm=T))

# or you want to know the mean (or some other stat) 
#for the whole year as opposed to each month...

meanwholeyear=squishdata %>%
  summarize(meanyear = mean(Temp, na.rm=TRUE))
```


















## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
summary(cars)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
